#!/bin/sh

# disable processing of 99video
uswsusp_hooks()
{
	disablehook 90chvt "disabled by uswsusp"
	disablehook 99video "disabled by uswsusp"
}

uswsusp_get_quirks()
{
	OPTS=""
	ACPI_SLEEP=0
	for opt in $PM_CMDLINE; do
		case "${opt##--quirk-}" in # just quirks, please
			dpms-on) 	   ;; # no-op
			dpms-suspend) 	   ;; # no-op
			radeon-off) 	   OPTS="$OPTS --radeontool" ;;
			reset-brightness)  ;; # no-op
			s3-bios) 	   ACPI_SLEEP=$(($ACPI_SLEEP + 1)) ;;
			s3-mode) 	   ACPI_SLEEP=$(($ACPI_SLEEP + 2)) ;;
			vbe-post) 	   OPTS="$OPTS --vbe_post" ;;
			vbemode-restore)   OPTS="$OPTS --vbe_mode" ;;
			vbestate-restore)  OPTS="$OPTS --vbe_save" ;;
			vga-mode3) 	   ;; # no-op
			save-pci)          OPTS="$OPTS --pci_save" ;;
			none) 		   QUIRK_NONE="true" ;;
			*) continue ;;
		esac
	done
	[ $ACPI_SLEEP -ne 0 ] && OPTS="$OPTS --acpi_sleep $ACPI_SLEEP"
	# if we were told to ignore quirks, do so.
	[ "$QUIRK_NONE" = "true" ] && OPTS=""
}

uswsusp_help()
{
	echo  # first echo makes it look nicer.
	echo "Video quirk handler options:"
	echo
	echo "  --quirk-dpms-on"
	echo "  --quirk-dpms-suspend"
	echo "  --quirk-radeon-off"
	echo "  --quirk-reset-brightness"
	echo "  --quirk-s3-bios"
	echo "  --quirk-s3-mode"
	echo "  --quirk-vbe-post"
	echo "  --quirk-vbemode-restore"
	echo "  --quirk-vbestate-restore"
	echo "  --quirk-vga-mode3"
	echo "  --quirk-save-pci"
	echo "  --quirk-none"
}

if [ -z "$SUSPEND_METHOD" ] && command_exists s2ram && \
	( grep -q mem /sys/power/state || \
		( [ -c /dev/pmu ] && pm-pmu --check; ); ); then
	SUSPEND_METHOD="uswsusp"
	do_suspend()
	{
		uswsusp_get_quirks
		s2ram --force $OPTS
	}
	if [ "$METHOD" = "suspend" ]; then
		add_before_hooks uswsusp_hooks
		add_module_help uswsusp_help
	fi
fi

if [ -z "$HIBERNATE_METHOD" ] && \
	[ -f /sys/power/disk ] && \
	grep -q disk /sys/power/state && \
	[ -c /dev/snapshot ] &&
	command_exists s2disk; then
	HIBERNATE_METHOD="uswsusp"
	do_hibernate()
	{
		s2disk
	}
fi

if [ -z "$SUSPEND_HYBRID_METHOD" ] && 
	grep -q mem /sys/power/state && \
	command_exists s2both && \
	check_hibernate; then
	SUSPEND_HYBRID_METHOD="uswsusp"
	do_suspend_hybrid()
	{
		uswsusp_get_quirks
		s2both --force $OPTS 
	}
	if [ "$METHOD" = "suspend_hybrid" ]; then
		add_before_hooks uswsusp_hooks
		add_module_help uswsusp_help
	fi
fi
